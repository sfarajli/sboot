#!/bin/sh

progname=$(basename "${0}")
VMSDIR="$HOME/.local/share/sboot"

help() {
cat << EOF_HELP
${progname}: QEMU wrapper with database
ONLY supports x86_64
Data directory: ~/.local/share/sboot

USAGE:
    ${progname} <COMMAND> [OPTIONS] [ARGS...]

COMMANDS:
    install  FILE             Install file (must be in correct format)
    image    [OPTIONS] OS     Manage OS disk images
    remove   [OPTIONS] OS     Remove OSes or files
    boot     [OPTIONS] OS     Boot virtual machine
    list                      List available OSes
    help                      Show this message

IMAGE OPTIONS:
    -r SIZE                   Resize disk (e.g., 20G, +5G)
    -i                        Show information
    -c                        Create file

BOOT OPTIONS:
    -i FILE                   Boot from ISO file (path or installed name)
    -e ARGS                   Add extra QEMU arguments (append)
    -a ARGS                   Overwrite all QEMU arguments (replace)

REMOVE OPTIONS:
    -f                        Silent
EOF_HELP
exit 0
}

err() {
	if [ "${1}" != "-x" ]; then
		printf "%s: " "${progname}"
	else
		shift
	fi

	for line in "${@}"; do
		echo "${line}" >&2
	done
	exit 1
}

invalid_use() {
	[ "${1}" = "-h" ] && err -x "Try '${progname} -h' for help."
	err "Invalid usage" "Try '${progname} help' for help."
}

check_program() {
	command -v "${1}" > /dev/null 2>&1 && return 0
	[ -n "${2}" ] && err "${2}"
	err "${1} must be installed"
}

check_arguments() {
	actual_argc="$1"; shift
	expected_argc="$1"; shift

	[ "${actual_argc}" -ne "${expected_argc}" ] && invalid_use
}

get_file() {
	DIRECTORY="$VMSDIR"
	BASEVM="$1"
	FILE_EXTENSION="$2"

	echo "$DIRECTORY"/"$BASEVM"/"$BASEVM""$FILE_EXTENSION"
}

vm_list() {
	LIST_DIRECTORY="${1:-.}"

	VM_INDEX=1
	for item in "$LIST_DIRECTORY"/*; do
		[ -e "$item" ] || continue
		name="${item##*/}"
		printf '%s. %s\n' "$VM_INDEX" "$name"
		VM_INDEX=$((VM_INDEX + 1))

		if [ -d "$item" ]; then
			for subitem in "$item"/*; do
				[ -e "$subitem" ] || continue
				subname="${subitem##*/}"
				printf '   - %s\n' "$subname"
			done
		fi
	done
}

vm_install() {
	[ -f "$1" ] || err "file not found: $1"

	INSTALLEXT=${1##*.}
	INSTALLVM=${1%.*}

	case "$INSTALLEXT" in
		qcow2|iso) ;;
		*) err "invalid extension: $1" ;;
	esac

	subdir="$VMSDIR"/"$INSTALLVM"
	mkdir -pv "$subdir"
	mv -- "$1" "$subdir/"
}

vm_image() {
	IMGACTION=""
	IMGSIZE=""

	OPTIND=1
	while getopts ":cir:" option; do
		case "$option" in
			c) IMGACTION="create" ;;
			i) IMGACTION="info" ;;
			r) IMGACTION="resize"; IMGSIZE="$OPTARG" ;;
			:) invalid_use ;;
			?) invalid_use -h ;;
		esac
	done
	shift $((OPTIND - 1))
	check_arguments $# 1

	IMGEXT=${1##*.}
	IMGVM=${1%.*}

	case "$IMGEXT" in
		qcow2|iso) ;;
		*) err "invalid extension: $1" ;;
	esac

	TARGET_IMG=$(get_file "$IMGVM" ".${IMGEXT}")

	case "$IMGACTION" in
		resize)
			check_program "qemu-img"
			[ -n "$IMGSIZE" ] || invalid_use

			if [ -f "$TARGET_IMG" ]; then
				qemu-img resize "$TARGET_IMG" "$IMGSIZE"
			else
				err "file not found: $TARGET_IMG"
			fi
			;;
		create)
			check_program "qemu-img"
			mkdir -pv "$(dirname "$TARGET_IMG")"

			if [ -e "$TARGET_IMG" ]; then
				err "file already exists: $TARGET_IMG"
			else
				qemu-img create -f qcow2 "$TARGET_IMG" 10G
			fi
			;;
		info)
			check_program "qemu-img"
			if [ -e "$TARGET_IMG" ]; then
				qemu-img info "$TARGET_IMG"
			else
				err "file not found: $TARGET_IMG"
			fi
			;;
		*)
			err "no action specified"
			;;
	esac
}

vm_remove() {
	RMFLAGS="-ri"

	OPTIND=1
	while getopts ":f" option; do
		case "$option" in
			f) RMFLAGS="-rf" ;;
			:) invalid_use ;;
			?) invalid_use -h ;;
		esac
	done
	shift $((OPTIND - 1))
	check_arguments $# 1

	TARGET="$1"
	TARGET_DIR="$VMSDIR/$TARGET"

	if [ -d "$TARGET_DIR" ]; then
		rm $RMFLAGS -- "$TARGET_DIR"
		return
	fi

	case "$TARGET" in
		*.qcow2|*.iso)
			BASE=${TARGET%.*}
			EXT=.${TARGET##*.}
			TARGET_FILE=$(get_file "$BASE" "$EXT")
			[ -e "$TARGET_FILE" ] || err "file not found: $TARGET_FILE"
			rm $RMFLAGS -- "$TARGET_FILE"
			# Remove empty directory after deleting the last file.
			if [ -d "$VMSDIR/$BASE" ] && [ -z "$(ls -A "$VMSDIR/$BASE" 2>/dev/null)" ]; then
				rmdir -- "$VMSDIR/$BASE" 2>/dev/null || true
			fi
			;;
		*)
			err "no such VM or file: $TARGET"
			;;
	esac
}

vm_boot() {
	DEFAULT_ARGS=1
	NEW_ARGS=""
	EXTENDED_ARGS=""
	ISO_ARG=""

	OPTIND=1
	while getopts ":a:e:i:" option; do
		case "$option" in
			a) DEFAULT_ARGS=0; NEW_ARGS="$OPTARG" ;;
			e) EXTENDED_ARGS="$EXTENDED_ARGS $OPTARG" ;;
			i) ISO_ARG="$OPTARG" ;;
			:) invalid_use ;;
			?) invalid_use -h ;;
		esac
	done
	shift $((OPTIND - 1))
	check_arguments $# 1

	check_program "qemu-system-x86_64"

	VM="$1"
	QCOW2_FILE=$(get_file "$VM" .qcow2)
	[ -f "$QCOW2_FILE" ] || err "disk image not found: $QCOW2_FILE"

	# Build argument vector.
	if [ "$DEFAULT_ARGS" -eq 1 ]; then
		set -- -enable-kvm -m 2G -smp 2 -drive "file=${QCOW2_FILE},format=qcow2" -net nic -net user
	else
		# Split NEW_ARGS on whitespace (caller can quote the whole string).
		set --
		# shellcheck disable=SC2086
		set -- $NEW_ARGS
	fi

	# If an ISO was requested, accept either an explicit path, or an installed ISO name.
	if [ -n "$ISO_ARG" ]; then
		if [ -f "$ISO_ARG" ]; then
			ISO_FILE="$ISO_ARG"
		else
			ISO_FILE=$(get_file "${ISO_ARG%.*}" .iso)
			[ -f "$ISO_FILE" ] || err "ISO not found: $ISO_ARG"
		fi
		set -- "$@" -cdrom "$ISO_FILE" -boot d
	fi

	if [ -n "$EXTENDED_ARGS" ]; then
		# shellcheck disable=SC2086
		set -- "$@" $EXTENDED_ARGS
	fi

	exec qemu-system-x86_64 "$@"
}

main() {
	[ $# -eq 0 ] && invalid_use

	mkdir -pv "$VMSDIR"

	ACTION="$1"; shift
	case "$ACTION" in
		install)
			check_arguments $# 1
			vm_install "$1"
			;;
		image)
			vm_image "$@"
			;;
		remove)
			vm_remove "$@"
			;;
		boot)
			vm_boot "$@"
			;;
		list)
			check_arguments $# 0
			vm_list "$VMSDIR"
			;;
		help)
			check_arguments $# 0
			help
			;;
		*) invalid_use ;;
	esac
}

main "$@"
